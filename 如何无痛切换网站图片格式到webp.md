# å¦‚ä½•æ— ç—›åˆ‡æ¢ç½‘ç«™å›¾ç‰‡æ ¼å¼åˆ°webp



[Mé…·](https://bbchin.com/s/about "Mé…·")

2021-09-07/6 è¯„è®º/12 ç‚¹èµ/1,571 é˜…è¯»/3,717 å­—/æ¨é€æˆåŠŸï¼

09/07

![ä¼˜é›…çš„è®© Halo æ”¯æŒ webp å›¾ç‰‡è¾“å‡º](https://bbchin.com/upload/2021/10/webp_compare-8a9a115ddb094290b53e4d21201254d4.webp)

## æ˜¯ä»€ä¹ˆï¼Ÿ

---

> WebPçš„æœ‰æŸå‹ç¼©ç®—æ³•æ˜¯åŸºäºVP8è§†é¢‘æ ¼å¼çš„å¸§å†…ç¼–ç [17]ï¼Œå¹¶ä»¥RIFFä½œä¸ºå®¹å™¨æ ¼å¼ã€‚[2] å› æ­¤ï¼Œå®ƒæ˜¯ä¸€ä¸ªå…·æœ‰å…«ä½è‰²å½©æ·±åº¦å’Œä»¥1:2çš„æ¯”ä¾‹è¿›è¡Œè‰²åº¦å­é‡‡æ ·çš„äº®åº¦-è‰²åº¦æ¨¡å‹ï¼ˆYCbCr 4:2:0ï¼‰çš„åŸºäºå—çš„è½¬æ¢æ–¹æ¡ˆã€‚[18] ä¸å«å†…å®¹çš„æƒ…å†µä¸‹ï¼ŒRIFFå®¹å™¨è¦æ±‚åªéœ€20å­—èŠ‚çš„å¼€é”€ï¼Œä¾ç„¶èƒ½ä¿å­˜é¢å¤–çš„ å…ƒæ•°æ®(metadata)ã€‚[2] WebPå›¾åƒçš„è¾¹é•¿é™åˆ¶ä¸º16383åƒç´ ã€‚

åœ¨Â `WebP`Â çš„å®˜ç½‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° Google æ˜¯è¿™æ ·å®£ä¼ Â `WebP`Â çš„ï¼š

> WebP lossless images are 26% smaller in size compared to PNGs. WebP lossy images are 25-34% smaller than comparable JPEG images at equivalent SSIM quality index.

ç®€å•æ¥è¯´ï¼Œ`WebP`Â å›¾ç‰‡æ ¼å¼çš„å­˜åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨Â `WebP`Â ä¸Šå±•ç¤ºçš„å›¾ç‰‡ä½“ç§¯å¯ä»¥æœ‰è¾ƒå¤§å¹…åº¦çš„ç¼©å°ï¼Œä¹Ÿå°±å¸¦æ¥äº†åŠ è½½æ€§èƒ½çš„æå‡ã€‚ï¼ˆæ‘˜è‡ªÂ [è®©ç«™ç‚¹å›¾ç‰‡åŠ è½½é€Ÿåº¦æ›´å¿«â€”â€”å¼•å…¥ WebP Server æ— ç¼è½¬æ¢å›¾ç‰‡ä¸º WebP](https://nova.moe/re-introduce-webp-server))

![pic_compare.png](https://bbchin.com/upload/2021/09/pic_compare-b12b1ac24136425799a09709b32f581b.png)

## æ€ä¹ˆåšï¼Ÿ

---

é‚£ä¹ˆå¦‚ä½•ä¼˜é›…çš„åœ¨ä¸æ›¿æ¢å›¾ç‰‡åœ°å€çš„æƒ…å†µä¸‹ï¼Œå°†å›¾ç‰‡è½¬ä¸ºÂ `webp`Â æ ¼å¼ç„¶åè¾“å‡ºå‘¢ï¼Ÿ

è¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨Â [webp-sh](https://github.com/webp-sh)Â ç»„ç»‡æœ€æ–°å¼€æºçš„Â [webp_server_go](https://github.com/webp-sh/webp_server_go)Â å·¥å…·äº†ã€‚

**åŸç†ï¼š**

å½“æˆ‘ä»¬è¯·æ±‚ä¸€å¼ å›¾ç‰‡çš„æ—¶å€™ä½¿ç”¨ web ä»£ç†å·¥å…·è½¬å‘åˆ°Â `webp_server_go`Â åº”ç”¨è¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œæˆä¹‹åè¿”å› webp æ ¼å¼çš„å›¾ç‰‡ï¼Œå¹¶ä¸”ä¼šä¿ç•™å¤„ç†åçš„å›¾ç‰‡ä»¥ä¾›åé¢çš„è®¿é—®ã€‚

ç›®å‰å¤§éƒ¨åˆ†ä¸»æµæµè§ˆå™¨éƒ½å·²ç»æ”¯æŒäº†Â `webp`Â å›¾ç‰‡çš„æ˜¾ç¤ºï¼Œé™¤äº†Â `Safari`ï¼Œä½†æ˜¯ä¸å¿…æ‹…å¿ƒï¼Œ`webp_server_go`Â ä¼šè‡ªåŠ¨åˆ¤æ–­è¯·æ±‚æ¥æºæ˜¯å¦ä¸ºÂ `Safari`ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆä¼šè¿”å›åŸå›¾ã€‚

ä¸‹é¢å°†æä¾›ä¸¤ç§ web æœåŠ¡å™¨çš„ä»£ç†æ–¹æ³•ã€‚

> æ­¤æ•™ç¨‹ä»¥Â `CentOS 7.x`Â ä¸ºä¾‹ï¼Œå…¶ä»–å‘è¡Œç‰ˆæœ¬å¤§åŒå°å¼‚ã€‚å¦å¤–ï¼Œæ­¤æ•™ç¨‹åªé’ˆå¯¹äºÂ `Halo`ï¼Œå…¶ä»– web ç¨‹åºå¯èƒ½åœ¨Â `config.json`Â éƒ¨åˆ†æœ‰æ‰€ä¸åŒï¼Œå»ºè®®å‚è€ƒä»“åº“çš„Â `README`ã€‚

### éƒ¨ç½² webp_server_go

åœ¨Â [ä»“åº“](https://github.com/webp-sh/webp_server_go)Â çš„ README ä¸­å·²ç»å¤§è‡´è®²è§£äº†éƒ¨ç½²æ–¹æ³•ï¼Œè¿™é‡Œé’ˆå¯¹Â [Haloåšå®¢å¹³å°](https://halo.run/)Â è¯¦ç»†è¯´æ˜ä¸€ä¸‹ã€‚

#### 1ã€ä¸‹è½½å®˜æ–¹ç¼–è¯‘å¥½çš„Â `webp_server_go`Â äºŒè¿›åˆ¶æ–‡ä»¶

> å¦‚æœä½ æœ‰èƒ½åŠ›ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œç¼–è¯‘ã€‚

â‘  æ–°å»ºä¸€ä¸ªå­˜æ”¾äºŒè¿›åˆ¶æ–‡ä»¶å’ŒÂ `config.json`Â æ–‡ä»¶çš„ç›®å½•ï¼ˆå¯è‡ªå®šä¹‰ï¼‰ï¼š

`mkdir /opt/webps
cd /opt/webps` 

â‘¡ ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæœ€æ–°ç‰ˆæœ¬è¯·è®¿é—®Â [releases](https://github.com/webp-sh/webp_server_go/releases)ï¼‰ï¼š

`wget https://github.com/webp-sh/webp_server_go/releases/download/0.3.2/webp-server-linux-amd64 -O webp-server` 

â‘¢ ç»™äºˆç›®å½•æ‰§è¡Œæƒé™ï¼š

`chmod +x webp-server`

#### 2ã€åˆ›å»ºÂ `config.json`

`{
    "HOST": "127.0.0.1",
    "PORT": "3333",
    "QUALITY": "80",
    "MAX_JOB_COUNT": "10",
    "IMG_PATH": "/root/.halo",
    "EXHAUST_PATH": "/root/.halo/cache",
    "ALLOWED_TYPES": ["jpg", "png", "jpeg", "bmp"]
}` 

**å‚æ•°è§£é‡Šï¼š**

`*   HOSTï¼šä¸€èˆ¬ä¸ä¿®æ”¹

* PORTï¼šwebp_server_go çš„è¿è¡Œç«¯å£
* QUALITYï¼šè½¬æ¢è´¨é‡ï¼Œé»˜è®¤ä¸º 80%
* MAX_JOB_COUNTï¼šåŒä¸€æ—¶é—´æœ€å¤§çš„è½¬æ¢æ•°ï¼Œè¶…è¿‡ä¼šæ’é˜Ÿ
* IMG_PATHï¼šå›ºå®šæ ¼å¼ï¼Œ/è¿è¡Œ Halo çš„ç”¨æˆ·å/.halo
* EXHAUST_PATHï¼šå›ºå®šæ ¼å¼ï¼Œ/è¿è¡Œ Halo çš„ç”¨æˆ·å/.halo/cache
* ALLOWED_TYPESï¼šéœ€è¦è½¬æ¢çš„æ ¼å¼` 

#### 3ã€ä½¿ç”¨Â `systemd`Â è¿›è¡ŒçŠ¶æ€ç®¡ç†

â‘  åˆ›å»ºÂ `service`Â æ–‡ä»¶ï¼š

`vim /etc/systemd/system/webps.service`

â‘¡ å†™å…¥é…ç½®ï¼š

`[Unit]
Description=WebP Server
Documentation=https://github.com/n0vad3v/webp_server_go
After=nginx.target

[Service]
Type=simple
StandardError=journal
AmbientCapabilities=CAP_NET_BIND_SERVICE
WorkingDirectory=/opt/webps
ExecStart=/opt/webps/webp-server --config /opt/webps/config.json
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=3s

[Install]
WantedBy=multi-user.target` 

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`ExecStart`Â å‘½ä»¤ä¸­çš„ç¨‹åºè·¯å¾„å’Œé…ç½®æ–‡ä»¶è·¯å¾„ä¸€å®šè¦æ­£ç¡®ï¼Œç»“åˆä½ çš„å®é™…æƒ…å†µå¡«å†™ã€‚

â‘¢ ç„¶åæ‰§è¡Œï¼š

`systemctl daemon-reload
systemctl enable webps.service
systemctl start webps.service` 

â‘£ æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼š

`systemctl status webps.service`

å¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆä¼šè¾“å‡ºä»¥ä¸‹æ—¥å¿—ï¼š

`WebP Server is running at 127.0.0.1:3333`

### ä½¿ç”¨Â `Nginx`Â è¿›è¡Œä»£ç†

> å¦‚æœä½ çš„Â `Halo`Â æ˜¯ä½¿ç”¨Â `Nginx`Â åå‘ä»£ç†çš„è¯ã€‚

#### 1ã€ä¿®æ”¹Â `halo.conf`Â æˆ–è‡ªå·±çš„Â `nginx.conf`Â æ–‡ä»¶

åœ¨Â `server`Â èŠ‚ç‚¹æ·»åŠ ï¼š

`location ^~ /upload/ {
  proxy_pass http://127.0.0.1:3333;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_hide_header X-Powered-By;
  proxy_set_header HOST $http_host;
  add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
}` 

#### 2ã€é‡è½½ Nginx é…ç½®ï¼š

`# æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰é—®é¢˜
nginx -t 

# é‡å¯nginx

nginx -s reload` 

### ä½¿ç”¨Â `Caddy`Â è¿›è¡Œä»£ç†

> å¦‚æœä½ çš„Â `Halo`Â æ˜¯ä½¿ç”¨Â `Caddy`Â åå‘ä»£ç†çš„è¯ã€‚

#### 1ã€ä¿®æ”¹Â `Caddyfile`

åœ¨ä½ åŸŸåèŠ‚ç‚¹ä¸‹æ·»åŠ ï¼š

`proxy /upload/ localhost:3333 {
  transparent
}` 

#### 2ã€é‡å¯Â `Caddy`ï¼š

`service caddy restart`

æ•™ç¨‹å®Œæ¯•ï¼Œä¸‹é¢è®²ä¸€ä¸‹å¦‚ä½•éªŒè¯æ˜¯å¦ç”Ÿæ•ˆã€‚

### éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ

![webp_img](https://bbchin.com/upload/2021/10/webp_img-be5807d3c5834876b43a554d247a1cd6.png)

æ³¨æ„çœ‹Â `ç±»å‹(Type)`Â åˆ—ï¼Œå›¾ç‰‡çš„è¿”å›æ ¼å¼å·²ç»å˜ä¸ºÂ `webp`ï¼Œè€Œä¸”å›¾ç‰‡å¤§å°å·²ç»è¿œè¿œé™ä½ï¼Œæ­¤æ—¶è¯´æ˜ä½ çš„é…ç½®å·²ç»æˆåŠŸäº†ã€‚ğŸ˜ have fun!

å¦‚æœç”¨çš„å¼€å¿ƒï¼Œè¯·å…³æ³¨ä¸€ä¸‹Â [GitHub - webp-sh/webp_server_go: Go version of WebP Server. A tool that will serve your JPG/PNGs as WebP format with compression, on-the-fly.](https://github.com/webp-sh/webp_server_go)Â å“¦ï¼å¦å¤–ï¼Œä»–ä»¬è¿˜æœ‰å…¶ä»–è¯­è¨€çš„ç‰ˆæœ¬ï¼Œè¯·æŸ¥çœ‹Â [WebP Server Â· GitHub](https://github.com/webp-sh)ã€‚

### é‡å¯ã€åœæ­¢å’Œå…³é—­æœåŠ¡

`// æŸ¥çœ‹ webps.server çŠ¶æ€
systemctl status webps.service

// é‡å¯ webps.service
systemctl restart webps.service

// åœæ­¢ webps.service
systemctl stop webps.service

// å…³é—­ webps.service
systemctl disable webps.service` 

å¦‚æœåç»­ä¸æƒ³ä½¿ç”¨Â `webp_server_go`Â äº†ï¼Œå…ˆåœæ­¢å¹¶å…³é—­Â `webps.service`ï¼Œç„¶åæ¢å¤ä»¥å‰çš„Â `Nginx`Â æˆ–Â `Caddy`Â é…ç½®æ–‡ä»¶å¹¶é‡å¯å³å¯ã€‚

## ğŸ‘ ä¼˜ç‚¹

- æ¥å…¥ç®€å•ï¼Œå¯åœ¨ä¸æ›¿æ¢åŸå›¾èµ„æºçš„æƒ…å†µä¸‹è¿›è¡Œè½¬æ¢ï¼›
- å¯¹å¤§å›¾ç‰‡æˆ–å›¾ç‰‡é‡æ¯”è¾ƒå¤§çš„ç½‘ç«™æ¥è¯´ï¼Œå¯ä»¥æ˜¾è‘—æé«˜é¦–å±åŠ è½½é€Ÿåº¦ï¼Œä¼˜åŒ–ç½‘ç«™æ€§èƒ½æŒ‡æ ‡ï¼›
- é’ˆå¯¹ä¸æ”¯æŒçš„å¹³å°ï¼Œæœ‰å›é€€æ–¹æ¡ˆï¼›

## ğŸ¤” é—®é¢˜

ç”±äºè¿™ç§æ–¹å¼æ˜¯é€šè¿‡æœåŠ¡ç«¯å³æ—¶å¯¹è¯·æ±‚çš„å›¾ç‰‡è¿›è¡Œè½¬æ¢åè¿”å›çš„ï¼Œå› æ­¤å¸¦æ¥äº†å¦‚ä¸‹é—®é¢˜ï¼š

- æµè§ˆå™¨æ— æ³•å†å¤ç”¨ä¹‹å‰å›¾ç‰‡çš„è¯·æ±‚ç¼“å­˜æ¥ä¼˜åŒ–æ€§èƒ½äº†ï¼›
  - æ­£å¸¸æƒ…å†µä¸‹æµè§ˆå™¨ä¼šé€šè¿‡ç¼“å­˜æ¥æé«˜äºŒæ¬¡åŠ è½½æ€§èƒ½
- æ¯æ¬¡æœåŠ¡ç«¯éƒ½å¾—è½¬æ¢ä¸€æ¬¡ï¼Œè®¿é—®é¢‘ç‡é«˜çš„æƒ…å†µä¸‹æœåŠ¡ç«¯å‹åŠ›å¤§ï¼›
- éƒ¨åˆ†ç‰¹æ®Šåœºæ™¯å¯èƒ½å¯¼è‡´å›¾ç‰‡è½¬æ¢å¤±è´¥ï¼Œæœ€ç»ˆæ— æ³•å±•ç¤ºã€‚
  - å¦‚åœ¨æœªé™åˆ¶å¹¶å‘è½¬æ¢æ•°çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªé¡µé¢åŒæ—¶è¯·æ±‚äº†å¤ªå¤šå›¾ç‰‡ï¼ˆå¦‚å›¾ç‰‡ç±»ç½‘ç«™ï¼‰ï¼Œå¾ˆå¯èƒ½å¯¼è‡´æœåŠ¡å™¨èµ„æºæ¶ˆè€—æ®†å°½è€Œç½„æœº
  - å•çº¯é€šè¿‡æ–‡ä»¶æ‰©å±•åæ— æ³•å‡†ç¡®åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œæ­¤æ—¶å¦‚æœä¸€å¼ å›¾ç‰‡å·²ç»æ˜¯Â `webp`ï¼Œåªæ˜¯æ‰©å±•åè¢«æ”¹ä¸ºÂ `jpg`Â ï¼Œé‚£ä¹ˆä»–å¯èƒ½ä¼šé‡å¤è½¬æ¢ç”šè‡³å¤±è´¥

## å‚è€ƒ

- [GitHub - webp-sh/webp_server_go: Go version of WebP Server. A tool that will serve your JPG/PNGs as WebP format with compression, on-the-fly.](https://github.com/webp-sh/webp_server_go)
- [è®©ç«™ç‚¹å›¾ç‰‡åŠ è½½é€Ÿåº¦æ›´å¿«â€”â€”å¼•å…¥ WebP Server æ— ç¼è½¬æ¢å›¾ç‰‡ä¸º WebP](https://nova.moe/re-introduce-webp-server/)
- [ä¸ªäººç½‘ç«™æ— ç¼åˆ‡æ¢å›¾ç‰‡åˆ° webp](https://www.bennythink.com/flying-webp.html)

[webp](https://bbchin.com/tags/webp)

Â ç‰ˆæƒå½’å±ï¼šÂ Mé…·

Â æœ¬æ–‡é“¾æ¥ï¼šÂ [å¦‚ä½•æ— ç—›åˆ‡æ¢ç½‘ç«™å›¾ç‰‡æ ¼å¼åˆ°webp](https://bbchin.com/archives/towebp)

Â è®¸å¯åè®®ï¼šÂ æœ¬æ–‡ä½¿ç”¨ã€Š[ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™… (CC BY-NC-SA 4.0)](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)ã€‹åè®®æˆæƒ
